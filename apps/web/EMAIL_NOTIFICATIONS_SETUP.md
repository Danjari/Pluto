# Email Notifications Setup Guide

This guide explains how to set up the course email notification system with Gemini AI and Resend.

## Features

- **Per-course settings**: Each course has its own notification preferences
- **Day selection**: Users can choose which days to receive reminders (Mon-Sun)
- **Timezone support**: Notifications sent at the right time in user's timezone
- **AI-generated content**: Duolingo-style "roasting" emails generated by Gemini
- **Test emails**: Users can send test emails to preview the content
- **Duplicate prevention**: System prevents sending multiple emails per day
- **Smart timing**: Only sends emails if user hasn't checked in today
- **Daily check-ins**: Users get a friendly mood check-in when opening courses

## Environment Variables

Add these to your `.env` file:

```env
# Email and AI Configuration
RESEND_API_KEY=re_your_resend_api_key_here
GEMINI_API_KEY=your_gemini_api_key_here
FROM_EMAIL=noreply@yourdomain.com
CRON_SECRET=your_cron_secret_token_here
```

## Setup Steps

### 1. Get API Keys

**Resend (Email Service):**
1. Sign up at [resend.com](https://resend.com)
2. Create an API key in your dashboard
3. Add your domain and verify it
4. Use the API key as `RESEND_API_KEY`

**Google Gemini (AI Content):**
1. Go to [Google AI Studio](https://makersuite.google.com/app/apikey)
2. Create an API key
3. Use it as `GEMINI_API_KEY`

### 2. Database Migration

The Prisma schema has been updated with new models:
- `CourseNotificationSettings`: Stores per-course notification preferences
- `EmailNotificationLog`: Tracks sent emails to prevent duplicates

Run the migration:
```bash
npx prisma db push
```

### 3. Deploy to Vercel

The system uses Vercel Cron Jobs to send emails hourly. The `vercel.json` file is configured to run the cron job every hour.

**Important:** Vercel Cron Jobs require a Pro plan for production use. For development, you can:
- Use the test email feature in the UI
- Manually trigger the cron endpoint
- Use an external cron service like [cron-job.org](https://cron-job.org)

### 4. Manual Cron Testing

To test the cron job manually:

```bash
curl -X POST https://your-domain.vercel.app/api/cron/send-reminders \
  -H "Authorization: Bearer your_cron_secret_token_here"
```

## How It Works

### User Flow
1. **Daily Check-in**: User opens course ‚Üí Gets friendly mood check-in modal
2. **Settings**: User clicks settings icon (‚öôÔ∏è) to configure notifications
3. **Configuration**: User toggles email notifications ON, selects study days (Mon-Sun)
4. **Testing**: User clicks "Send Test Email Now" to preview
5. **Smart Reminders**: At 9 PM on study days, user receives emails only if they haven't checked in today

### Daily Check-in System

**How it works:**
- When users open a course, they see a friendly "How are you feeling today?" modal
- **Pluto mascot** greets users with a warm welcome and encouraging messages
- Users can select their mood (Amazing, Great, Okay, Struggling, Tired, Focused)
- **Interactive feedback** - Pluto responds differently to each mood selection
- Optional notes about their study session
- This check-in counts as "studied today" for email purposes
- Only shows once per day per course (resets at midnight)
- Visual indicator shows "ü™ê Checked in today" in the course header

### Cron Job Flow
1. Cron job runs every hour
2. For each user with enabled notifications:
   - Check if today is a study day
   - Check if current time matches notification time (within 1 hour)
   - Check if email already sent today
   - Check if user has checked in today (daily check-in system)
   - Generate personalized content with Gemini
   - Send email via Resend
   - Log the email to prevent duplicates

### Email Content
- **Subject**: Generated by Gemini (e.g., "Don't abandon your React course! üò§")
- **Body**: Personalized "roasting" message with:
  - User's name and course title
  - Progress percentage
  - Days since last study
  - Motivational content
- **Template**: Professional HTML template with course link and unsubscribe option

## API Endpoints

- `GET /api/courses/[id]/settings/notifications` - Get notification settings
- `POST /api/courses/[id]/settings/notifications` - Save notification settings
- `POST /api/courses/[id]/settings/test-email` - Send test email
- `POST /api/cron/send-reminders` - Cron job endpoint (protected)

## Troubleshooting

### Common Issues

1. **Emails not sending**: Check Resend API key and domain verification
2. **Gemini errors**: Verify API key and check rate limits
3. **Cron not running**: Ensure Vercel Pro plan and correct `vercel.json`
4. **Timezone issues**: Check user's timezone setting in database

### Logs

Check Vercel function logs for cron job execution:
```bash
vercel logs --follow
```

### Testing

Use the test email feature in the course settings to verify everything works before relying on the cron job.

## Scaling Considerations

- **Small scale (< 10k users)**: Current setup works fine
- **Medium scale (10k-100k)**: Consider batch processing and rate limiting
- **Large scale (100k+)**: Use job queues like BullMQ or Inngest

## Security

- Cron endpoint is protected with `CRON_SECRET` token
- User authentication required for all settings endpoints
- Email addresses are validated before sending
- Rate limiting prevents spam
